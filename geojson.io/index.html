<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEAFLET</title>
    <link rel="stylesheet" href="./leaflet/leaflet.css"/>
    <link rel="stylesheet" href="./LeafletStyleEditor/Leaflet.StyleEditor.css"/>
    <script src="./leaflet/leaflet.js"></script>
    <script src="SelfDefinedControls/BottomInfo.js"></script>
    <script src="SelfDefinedControls/Btns.js"></script>
    <script src="./files.js"></script>
    <script src="./LeafletStyleEditor/Leaflet.StyleEditor.js"></script>
    <script src="./wkt/wkt.js"></script>
    <script src="./wkt/wicket-leaflet.js"></script>
    <script src="./paste.js"></script>
    <script src="SelfDefinedControls/JsonDrawer.js"></script>
    <script src="SelfDefinedControls/ListDrawer.js"></script>

    <script src="./leaflet/draw/leaflet.draw-src.js"></script>
    <link rel="stylesheet" href="./leaflet/draw/leaflet.draw.css"/>

    <link rel="stylesheet" href="./codemirror-5.31.0/lib/codemirror.css"/>
    <script src="./codemirror-5.31.0/lib/codemirror.js"></script>
    <!--Javaä»£ç é«˜äº®å¿…é¡»å¼•å…¥-->
    <script src="./codemirror-5.31.0/clike.js"></script>
    <!--groovyä»£ç é«˜äº®-->
    <script src="./codemirror-5.31.0/mode/groovy/groovy.js"></script>
    <script src="./codemirror-5.31.0/mode/python/python.js"></script>
    <script src="./codemirror-5.31.0/mode/javascript/javascript.js"></script>
    <!--å¼•å…¥cssæ–‡ä»¶ï¼Œç”¨ä»¥æ”¯æŒä¸»é¢˜-->
    <link rel="stylesheet" href="./codemirror-5.31.0/theme/dracula.css"/>

    <!--æ”¯æŒä»£ç æŠ˜å -->
    <link rel="stylesheet" href="./codemirror-5.31.0/addon/fold/foldgutter.css"/>
    <script src="./codemirror-5.31.0/addon/fold/foldcode.js"></script>
    <script src="./codemirror-5.31.0/addon/fold/foldgutter.js"></script>
    <script src="./codemirror-5.31.0/addon/fold/brace-fold.js"></script>
    <script src="./codemirror-5.31.0/addon/fold/comment-fold.js"></script>
    <!--æ‹¬å·åŒ¹é…-->
    <script src="./codemirror-5.31.0/addon/edit/matchbrackets.js"></script>

    <script src="./cacheObject.js"></script>
    <link rel="stylesheet" href="./leaflet/leaflet-custrom.css"/>
    <script src="SelfDefinedControls/DrawFeature.js"></script>

    <script src="SelfDefinedControls/LayerControl.js"></script>

    <style>
        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            border: none;
            display: flex;
            flex-direction: row;
        }
        #leftPanel {
            display: none;
            width: 500px;
            height: calc(100vh - 20px);
            flex-direction: column;
        }
        .layer-item {
            padding: 10px;
        }
        .layer-item-content {
            background: #d5d5d5;
            padding: 10px;
            border-radius: 5px;
        }
        .layer-item-content>div {
            margin-bottom: 5px;
        }
        .layer-item-li {}
        .layer-item-btn {}
        #map {
            width: 100vw;
            height: 100vh;
        }

        .leaflet-draw-toolbar {
            background: white !important;
        }
        .leaflet-draw-toolbar a {
            background-color: white;
        }
        .leaflet-draw-toolbar a:hover {
            background-color: #d6d6d6;
        }
        .leaflet-control-styleeditor a {
            background-color: white;
        }
        .leaflet-control-styleeditor a:hover {
            background-color: #d6d6d6;
        }
        .leaflet-bottom {
            bottom: 25px;
        }

        ::-webkit-scrollbar {
            width: 6px;   /* ç«–å‘æ»šåŠ¨æ¡å®½åº¦ */
            height: 6px;  /* æ¨ªå‘æ»šåŠ¨æ¡é«˜åº¦ */
        }

        ::-webkit-scrollbar-track {
            background: transparent;  /* æ»šåŠ¨æ¡è½¨é“èƒŒæ™¯ */
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.3); /* æ»šåŠ¨æ¡é¢œè‰² */
            border-radius: 3px;       /* æ»šåŠ¨æ¡åœ†è§’ */
            border: 1px solid transparent; /* ç»™æ»šåŠ¨æ¡åŠ ä¸ªé€æ˜è¾¹æ¡†ï¼Œé˜²æ­¢è·³åŠ¨ */
        }

        /* Firefox */
        * {
            scrollbar-width: thin;        /* æ»šåŠ¨æ¡ç»† */
            scrollbar-color: rgb(156 255 40) transparent; /* æ»šåŠ¨æ¡é¢œè‰²å’Œè½¨é“ */
        }
    </style>
</head>
<body>
<div id="leftPanel">
    <div class="layer-item" id="layers">
    </div>
</div>
<div id="map"></div>
<script src="./toast.js"></script>
<script>
    window.map = L.map('map', {}).setView([30.524068012003553, 119.96731403840286], 15);

    window.layers = [];
    window.layers_ids = [];
    window.df = new DrawFeature(window.map,() => {
        layerEditor._container.style.display = 'none';
        document.getElementById('custom-btn-funs').style.display = 'none';
    });
    new BottomInfo(window.map);
    function addParseObjToMap(obj, options = {}, id="", name="", update=false) {
        if (window.layers_ids.includes(id)) {
            let target_layer = window.layers.filter(l => l.id === id);
            if (target_layer.length > 0) {
                map.fitBounds(target_layer[0].getBounds())
            }
            if (update) {
                window.cacheLayerStyle.updateLayer(obj, id);
            }
            return;
        }
        let geo = null;
        if (obj.type === window.vectorType.geojson) {
            console.log("add obj")
            geo = L.geoJSON(obj.data, {
                style: function () {
                    return {
                        color: 'blue',
                        weight: 2,
                    }
                },
                pointToLayer: function (feature, latlng) {
                    if (feature.properties && feature.properties._type === "circle") {
                        return L.circle(latlng, {
                            radius: feature.properties._radius || 100,
                            color: 'red'
                        });
                    } else {
                        return L.marker(latlng);
                    }
                },
            });

        } else if (obj.type === window.vectorType.wkt) {
            // obj.data.addTo(window.map);
            // window.map.fitBounds(obj.data.getBounds());
            if (typeof obj.data === 'string') {
                let wkt = new Wkt.Wkt();
                wkt.read(obj.data);
                let json = wkt.toJson()
                return addParseObjToMap({
                    type: window.vectorType.geojson,
                    data: {
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "type": "Feature",
                                "properties": {},
                                "geometry": json
                            }
                        ]
                    }
                }, options, id, name);
            } else {
                geo = obj.data;
            }
        }
        if (geo) {
            // geo.eachLayer(function (layer) {
            //     drawnItems.addLayer(layer);
            // });
            geo.setStyle(options);
            geo.addTo(window.map);
            window.map.fitBounds(geo.getBounds());
            window.layers.push(geo);
            const cacheObj = window.cacheLayerStyle.addNewLayer(geo, obj, id, name);
            window.df.addFeature(geo, geo.id)
            window.layers_ids.push(geo.id);

            const MyLayerControl = LayerControl(geo, {
                id: geo.id,
                name: cacheObj.name,
                onDelete(layer, id) {
                    window.layers_ids.splice(window.layers_ids.indexOf(id), 1)
                },
                onExport(layer) {
                    let obj = customExport(layer);
                    openEditor(JSON.stringify(obj.geojson, '', '\t'));
                },
                onEdit(layer) {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    window.FeatureEditing = true;
                    // console.log(layer)
                    window.df.toDraw(layer.id);
                }
            });
            map.addControl(new MyLayerControl({
                position: 'bottomright',
            }));
        }
    };

    // æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®æ§ä»¶
    function openHistoryDrawer() {
        let allLayers = window.cacheObject.get(window.layer_cache_name, []).map(o => {
            return {
                name: o.name,
                value: o.id
            };
        });
        ListDrawer.initDrawer({
            title: "å†å²è®°å½•",
            items: allLayers,
            onSelect(item) {
                console.log(item);
                let obj = window.cacheObject.get(`layer.${item.value}.obj`, {});
                let opt = window.cacheObject.get(`layer.${item.value}.style`, {});
                addParseObjToMap(obj, opt, item.value, item.name);
            },
            onDelete(item) {
                let ok = confirm("åˆ é™¤åæ— æ³•æ¢å¤");
                if (ok) {
                    window.cacheObject.delete(`layer.${item.value}.obj`, {});
                    window.cacheObject.delete(`layer.${item.value}.style`, {});
                    let newAllLayers = window.cacheObject.get(window.layer_cache_name, []).filter(l => l.id !== item.value);
                    window.cacheObject.set(window.layer_cache_name, newAllLayers);
                    openHistoryDrawer();
                }
            }
        })
    };

    window.FeatureEditing = false;
    window.openEditor = function (content) {
        if (window.FeatureEditing) {
            Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
            return;
        }
        JsonDrawer.initDrawer({
            initialData: content || "",
            onSave: function () {
                let obj = window.editor.getValue();
                try {
                    obj = JSON.parse(obj);
                    addParseObjToMap({
                        type: window.vectorType.geojson,
                        data: obj,
                    });
                    return;
                } catch (e){
                    try {
                        addParseObjToMap({type: window.vectorType.wkt, data: obj});
                    } catch (e) {}
                }
                console.log(obj);
            }
        });
    };
    L.control.customButtons({
        position: "topleft",
        btns: [
            {
                text: "åˆ›å»ºçŸ¢é‡ğŸŒ",
                action() {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    window.FeatureEditing = true;
                    window.df._init_drawer_();
                }
            },
            {
                text: "ç»“æŸç¼–è¾‘ğŸ”’",
                action() {
                    if (window.FeatureEditing) {
                        window.FeatureEditing = false;
                        layerEditor._container.style.display = 'block';
                        document.getElementById('custom-btn-funs').style.display = 'block';
                        let obj = window.df.getDrawObj();
                        if (window.df.currentEditId) {
                            // æ›´æ–°
                            addParseObjToMap({
                                type: window.vectorType.geojson,
                                data: obj.geojson
                            }, obj.options, window.df.currentEditId, "", true);
                        } else {
                            if (obj.geojson.features.length) {
                                // æ·»åŠ 
                                addParseObjToMap({
                                    type: window.vectorType.geojson,
                                    data: obj.geojson
                                }, obj.options);
                            } else {
                                Toast("æœªæ·»åŠ ä»»ä½•çŸ¢é‡")
                            }
                        }
                        window.df.stopDrawing();
                    }
                }
            },
        ]
    }).addTo(map);
    L.control.customButtons({
        id: "custom-btn-funs",
        position: "topleft",
        btns: [
            {
                text: "æ‰“å¼€ğŸ“ƒ",
                action() {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    openVector().then(addParseObjToMap);
                },
            },
            {
                text: "ç²˜è´´ğŸª¡",
                action() {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    pasteFromClipboard().then(addParseObjToMap)
                },
            },
            {
                text: "GeoStrâœ’ï¸",
                action() {
                    // if (window.FeatureEditing) {
                    //     Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                    //     return;
                    // }
                    // JsonDrawer.initDrawer({ onSave: function () {
                    //     let obj = window.editor.getValue();
                    //     try {
                    //         obj = JSON.parse(obj);
                    //         addParseObjToMap({
                    //             type: window.vectorType.geojson,
                    //             data: obj,
                    //         });
                    //         return;
                    //     } catch (e){
                    //         try {
                    //             addParseObjToMap({type: window.vectorType.wkt, data: obj});
                    //         } catch (e) {}
                    //     }
                    //     console.log(obj);
                    // }});
                    openEditor("");
                },
            },
            {
                text: "å†å²ğŸª£",
                action() {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    openHistoryDrawer();
                },
            },
            {
                text: "å¯¼å‡ºçŸ¢é‡ğŸ˜˜",
                action() {
                    if (window.FeatureEditing) {
                        Toast('è¯·å…ˆç»“æŸç¼–è¾‘');
                        return;
                    }
                    let allLayers = new L.FeatureGroup();
                    map.eachLayer(layer => {
                        // åªæ”¶é›†çŸ¢é‡å›¾å±‚ï¼ˆä¸åŒ…æ‹¬ tile å›¾å±‚ã€åº•å›¾ç­‰ï¼‰
                        if (layer instanceof L.Path || layer instanceof L.Marker) {
                            allLayers.addLayer(layer);
                        }
                    });

                    let geojson = customExport(allLayers);
                    if (geojson.geojson.features.length) {
                        const blob = new Blob([JSON.stringify(geojson.geojson, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'map_export.geojson';
                        link.click();
                        if (geojson.hasCirle) {
                            Toast("æ³¨æ„ï¼šå½“å‰çŸ¢é‡ä¸­åŒ…å«[åœ†è¦ç´ ]ï¼Œåœ¨å…¶ä»–å¹³å°å°†æ˜¾ç¤ºä¸ºç‚¹ã€‚")
                        }
                    } else {
                        Toast("åœ°å›¾ä¸­æ²¡æœ‰å¯ä»¥å¯¼å‡ºçš„è¦ç´ ");
                    }
                }
            },
        ],
    }).addTo(window.map);

    window.layerEditor = L.control.styleEditor({
        checkBeforeOnLayerAdd() {
            return !window.FeatureEditing;
        }
    });
    window.map.addControl(window.layerEditor);
    // new Array(...document.getElementsByClassName('leaflet-control-styleeditor')).forEach(_ => _.style.display = 'none');
</script>
</body>
</html>